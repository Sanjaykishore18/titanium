{% extends 'base.html' %}

{% block title %}Team Dashboard - {{ team.team_name }}{% endblock %}

{% block extra_css %}
<style>
    body {
        background: #000000 !important;
        color: #ffffff !important;
    }

    .main-header {
        background: linear-gradient(135deg, #5B21B6 0%, #7C3AED 100%);
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 10px 40px rgba(91, 33, 182, 0.4);
    }

    .main-header h1 {
        font-size: 2.5rem;
        font-weight: 800;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 3px;
    }

    .main-header .subtitle {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-top: 5px;
    }

    .start-round-btn {
        background: linear-gradient(135deg, #5B21B6 0%, #7C3AED 100%);
        border: 2px solid #7C3AED;
        color: white;
        padding: 12px 24px;
        font-size: 16px;
        font-weight: 700;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        width: 100%;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .start-round-btn:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 10px 30px rgba(124, 58, 237, 0.6);
        background: linear-gradient(135deg, #6D28D9 0%, #8B5CF6 100%);
    }
    
    .start-round-btn:disabled {
        background: #1f1f1f;
        border-color: #333;
        cursor: not-allowed;
        transform: none;
        opacity: 0.5;
        color: #666;
    }

    .stat-card {
        background: #0a0a0a;
        border: 2px solid #1f1f1f;
        border-radius: 12px;
        transition: all 0.3s;
        overflow: hidden;
    }
    
    .stat-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 15px 40px rgba(124, 58, 237, 0.3);
        border-color: #7C3AED;
    }

    .stat-card .card-body {
        padding: 25px;
        background: #0a0a0a;
    }

    .stat-card h2 {
        font-size: 3rem;
        font-weight: 800;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #7C3AED 0%, #A78BFA 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stat-card p {
        color: #ffffff;
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 5px;
    }

    .stat-card small {
        color: #888;
        font-size: 0.85rem;
    }

    .card {
        background: #0a0a0a;
        border: 2px solid #1f1f1f;
        border-radius: 12px;
        color: #ffffff;
    }

    .card-header {
        border-bottom: 2px solid #1f1f1f;
        padding: 20px 25px;
        font-weight: 700;
    }

    .card-header h4,
    .card-header h5 {
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 1.5px;
    }

    .bg-primary {
        background: linear-gradient(135deg, #5B21B6 0%, #7C3AED 100%) !important;
    }

    .bg-info {
        background: linear-gradient(135deg, #5B21B6 0%, #7C3AED 100%) !important;
    }

    .bg-dark {
        background: linear-gradient(135deg, #5B21B6 0%, #7C3AED 100%) !important;
    }

    .round-card {
        background: #0a0a0a;
        border: 2px solid #1f1f1f;
        transition: all 0.3s;
        height: 100%;
    }
    
    .round-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(124, 58, 237, 0.3);
        border-color: #7C3AED;
    }

    .round-card.border-success {
        border-color: #7C3AED !important;
        border-width: 3px !important;
        box-shadow: 0 0 20px rgba(124, 58, 237, 0.4);
    }

    .round-card .card-header {
        padding: 15px;
        border-bottom: 2px solid #1f1f1f;
    }

    .round-card .card-header h5 {
        font-size: 1.3rem;
        margin-bottom: 5px;
    }

    .round-card .card-body {
        padding: 20px;
    }

    .bg-success {
        background: linear-gradient(135deg, #5B21B6 0%, #7C3AED 100%) !important;
    }

    .bg-secondary {
        background: #1f1f1f !important;
        color: #888 !important;
    }

    .badge {
        padding: 6px 12px;
        font-weight: 600;
        border-radius: 6px;
        font-size: 0.9rem;
    }

    .badge.bg-primary {
        background: linear-gradient(135deg, #5B21B6 0%, #7C3AED 100%) !important;
    }

    .badge.bg-success {
        background: linear-gradient(135deg, #059669 0%, #10B981 100%) !important;
    }

    .badge.bg-warning {
        background: linear-gradient(135deg, #D97706 0%, #F59E0B 100%) !important;
        color: #000 !important;
    }

    .badge.bg-info {
        background: linear-gradient(135deg, #0891B2 0%, #06B6D4 100%) !important;
    }

    .badge.bg-secondary {
        background: #333 !important;
        color: #aaa !important;
    }

    .alert {
        border-radius: 8px;
        border: none;
        font-weight: 600;
    }

    .alert-success {
        background: rgba(16, 185, 129, 0.15);
        color: #10B981;
        border: 1px solid #10B981;
    }

    .alert-warning {
        background: rgba(245, 158, 11, 0.15);
        color: #F59E0B;
        border: 1px solid #F59E0B;
    }

    .table {
        color: #ffffff;
        margin-bottom: 0;
    }

    .table thead th {
        background: #1f1f1f;
        color: #ffffff;
        border-bottom: 2px solid #7C3AED;
        padding: 15px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 0.9rem;
    }

    .table tbody tr {
        border-bottom: 1px solid #1f1f1f;
        transition: all 0.2s;
    }

    .table tbody tr:hover {
        background: rgba(124, 58, 237, 0.1);
    }

    .table tbody td {
        padding: 15px;
        vertical-align: middle;
    }

    .table-primary {
        background: rgba(124, 58, 237, 0.2) !important;
        border-left: 4px solid #7C3AED;
    }

    .member-card {
        background: #0a0a0a;
        border: 2px solid #1f1f1f;
        border-radius: 10px;
        transition: all 0.3s;
    }

    .member-card:hover {
        transform: translateY(-5px);
        border-color: #7C3AED;
        box-shadow: 0 10px 25px rgba(124, 58, 237, 0.3);
    }

    .member-card .card-body {
        padding: 20px;
        background: #0a0a0a;
    }

    .text-muted {
        color: #888 !important;
    }

    .text-primary {
        color: #7C3AED !important;
    }

    .text-success {
        color: #10B981 !important;
    }

    .text-info {
        color: #06B6D4 !important;
    }

    .text-warning {
        color: #F59E0B !important;
    }

    .fa-trophy {
        color: #F59E0B;
    }

    .section-divider {
        height: 2px;
        background: linear-gradient(90deg, transparent, #7C3AED, transparent);
        margin: 40px 0;
    }

    /* Icon colors */
    .text-primary i {
        color: #7C3AED !important;
    }
</style>
{% endblock %}

{% block content %}
<!-- MAIN HEADER -->
<div class="main-header text-center">
    <h1><i class="fas fa-door-open"></i> WEB ESCAPE</h1>
    <p class="subtitle">{{ team.team_name }}</p>
</div>

<!-- TEAM STATS ROW -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center stat-card">
            <div class="card-body">
                <h2>{{ total_score }}</h2>
                <p class="mb-0">Total Score</p>
                <small class="text-muted">of 300 pts</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center stat-card">
            <div class="card-body">
                <h2>#{{ team_rank }}</h2>
                <p class="mb-0">Rank</p>
                <small class="text-muted">of {{ total_teams }} teams</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center stat-card">
            <div class="card-body">
                <h2>{{ team.member_count }}</h2>
                <p class="mb-0">Members</p>
                <small class="text-muted">in team</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center stat-card">
            <div class="card-body">
                <h2>{{ rounds_completed }}/3</h2>
                <p class="mb-0">Completed</p>
                <small class="text-muted">rounds done</small>
            </div>
        </div>
    </div>
</div>

<!-- ROUNDS SECTION -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-gamepad"></i> Game Rounds</h4>
            </div>
            <div class="card-body p-4">
                <div class="row">
                    {% for round_obj, progress in rounds_with_progress %}
                    <div class="col-md-4 mb-3">
                        <div class="card h-100 round-card {% if round_obj.is_open %}border-success border-3{% endif %}">
                            <div class="card-header text-center {% if round_obj.is_open %}bg-success text-white{% else %}bg-secondary text-white{% endif %}">
                                <h5 class="mb-1">
                                    {% if round_obj.round_number == 1 %}
                                        üé≠ Stranger Things
                                    {% elif round_obj.round_number == 2 %}
                                        üè¥‚Äç‚ò†Ô∏è One Piece
                                    {% else %}
                                        üéÆ Squid Game
                                    {% endif %}
                                </h5>
                                <small>Round {{ round_obj.round_number }} ‚Ä¢ {{ round_obj.duration_minutes }}m</small>
                            </div>
                            <div class="card-body">
                                <p class="mb-2">
                                    <strong>Status:</strong> 
                                    <span class="badge {% if progress.status == 'completed' or progress.status == 'qualified' %}bg-success{% elif progress.status == 'in_progress' %}bg-warning text-dark{% else %}bg-secondary{% endif %}">
                                        {{ progress.get_status_display }}
                                    </span>
                                </p>
                                
                                <p class="mb-2">
                                    <strong>Score:</strong> 
                                    <span class="badge bg-primary">{{ progress.score }}/100</span>
                                </p>
                                
                                <p class="mb-3">
                                    <strong>Progress:</strong> {{ progress.pages_completed }}/10
                                </p>
                                
                                {% if progress.is_qualified %}
                                    <div class="alert alert-success py-2 mb-3">
                                        <i class="fas fa-check-circle"></i> <strong>Qualified!</strong>
                                    </div>
                                {% endif %}
                                
                                {% if progress.status == 'in_progress' %}
                                    <div class="alert alert-warning py-2 mb-3">
                                        <i class="fas fa-clock"></i> <strong>In Progress</strong>
                                    </div>
                                {% endif %}
                                
                                <div class="mt-3">
                                    {% if round_obj.is_open %}
                                        {% if progress.status == 'not_started' %}
                                            <button class="start-round-btn"
                                                onclick="startRound(event, '{{ round_obj.round_number }}')">
                                                <i class="fas fa-play"></i> Start
                                            </button>
                                        {% elif progress.status == 'in_progress' %}
                                            <button class="start-round-btn"
                                                onclick="startRound(event, '{{ round_obj.round_number }}')">
                                                <i class="fas fa-redo"></i> Continue
                                            </button>
                                        {% elif progress.status == 'completed' or progress.status == 'qualified' %}
                                            <button class="start-round-btn" disabled>
                                                <i class="fas fa-check-circle"></i> Done
                                            </button>
                                        {% elif progress.status == 'time_over' %}
                                            <button class="start-round-btn" disabled>
                                                <i class="fas fa-clock"></i> Time Over
                                            </button>
                                        {% endif %}
                                    {% else %}
                                        <button class="start-round-btn" disabled>
                                            <i class="fas fa-lock"></i> Locked
                                        </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- LEADERBOARD -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-trophy"></i> Leaderboard</h5>
            </div>
            <div class="card-body">
                {% if top_teams %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 80px;">Rank</th>
                                    <th>Team</th>
                                    <th class="text-center">Members</th>
                                    <th class="text-center">Rounds</th>
                                    <th class="text-end">Score</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for team_item in top_teams %}
                                <tr {% if team_item.id == team.id %}class="table-primary"{% endif %}>
                                    <td class="fw-bold">
                                        {% if forloop.counter == 1 %}
                                            <span style="font-size: 24px;">ü•á</span>
                                        {% elif forloop.counter == 2 %}
                                            <span style="font-size: 24px;">ü•à</span>
                                        {% elif forloop.counter == 3 %}
                                            <span style="font-size: 24px;">ü•â</span>
                                        {% else %}
                                            #{{ forloop.counter }}
                                        {% endif %}
                                    </td>
                                    <td>
                                        <strong>{{ team_item.team_name }}</strong>
                                        {% if team_item.id == team.id %}
                                            <span class="badge bg-success ms-2">You</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-secondary">{{ team_item.members_count|default:team_item.member_count }}</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-warning text-dark">{{ team_item.rounds_completed }}/3</span>
                                    </td>
                                    <td class="text-end">
                                        <span class="badge bg-primary" style="font-size: 16px;">{{ team_item.total_score|default:0 }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-users fa-3x mb-3"></i>
                        <p>No teams yet. Be the first!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- TEAM MEMBERS -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="fas fa-users"></i> Team Members ({{ team.member_count }})</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for member in team.members.all %}
                    <div class="col-md-3 mb-3">
                        <div class="card member-card">
                            <div class="card-body text-center">
                                <div class="mb-2">
                                    <i class="fas fa-user-circle fa-3x text-primary"></i>
                                </div>
                                <h6 class="mb-1">{{ member.username }}</h6>
                                <small class="text-muted">{{ member.email }}</small>
                                <div class="mt-2">
                                    <small class="badge bg-info">
                                        {{ member.joined_at|timesince }} ago
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ================================
// START ROUND FUNCTION
// ================================
async function startRound(event, roundNumber) {
    const btn = event.currentTarget;
    const originalHTML = btn.innerHTML;
    try {
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
        btn.disabled = true;

        const response = await fetch('/api/start-game/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                round_number: roundNumber
            })
        });

        if (response.status === 401 || response.status === 403) {
            alert('Session expired. Please login again.');
            window.location.href = '/login/';
            return;
        }

        const data = await response.json();

        if (!response.ok || data.error) {
            alert(data.error || 'Failed to start round.');
            btn.innerHTML = originalHTML;
            btn.disabled = false;
            return;
        }

        if (data.success && data.page_url) {
            btn.innerHTML = '<i class="fas fa-check"></i> Opening Game...';

            // ‚úÖ FIX: Store ALL session data before redirect
            localStorage.setItem('team_id', data.team_id);
            localStorage.setItem('current_round', data.round_number);
            localStorage.setItem('current_page', data.current_page);  // ‚úÖ NEW
            localStorage.setItem('game_token', data.token);            // ‚úÖ NEW

            setTimeout(() => {
                window.location.href = data.page_url;
            }, 400);
        } else {
            throw new Error('Invalid server response');
        }

    } catch (err) {
        console.error('Start round error:', err);
        alert('Something went wrong. Please try again.');
        btn.innerHTML = originalHTML;
        btn.disabled = false;
    }
}

// ================================
// CSRF TOKEN HELPER
// ================================
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}